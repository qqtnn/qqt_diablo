
local altar_table = {
    -- Kehjistan
    {position = vec3:new(-220.1300048828125, -279.4429931640625, 7.71481990814209), interacted = false},
    {position = vec3:new(-71.51229858398438, -696.8330078125, -9.75), interacted = false},
    {position = vec3:new(233.88999938964844, -530.6959838867188, 30.92930030822754), interacted = false},
    {position = vec3:new(218.11700439453125, -174.47900390625, 52.98350143432617), interacted = false},
    {position = vec3:new(76.6083984375, -236.42599487304688, 12.304699897766113), interacted = false},
    {position = vec3:new(233.63499450683594, -533.02197265625, 31.070899963378906), interacted = false},
    {position = vec3:new(75.24240112304688, -235.69200134277344, 11.444299697875977), interacted = false},
    {position = vec3:new(436.7019958496094, -175.83900451660156, 11.071700096130371), interacted = false},
    {position = vec3:new(436.68798828125, -174.58799743652344, 10.036600112915039), interacted = false},
    {position = vec3:new(436.5575866699219, -175.32278442382812, 10.55047607421875), interacted = false},
    {position = vec3:new(-220.322998046875, -638.0349731445312, 12.466500282287598), interacted = false},
    {position = vec3:new(-197.79800415039062, -414.1199951171875, 8.275710105895996), interacted = false},
    {position = vec3:new(-96.80249786376953, -351.4679870605469, 8.827329635620117), interacted = false},
    {position = vec3:new(15.522100448608398, -621.6690063476562, 4.495230197906494), interacted = false},
    {position = vec3:new(155.6490020751953, -585.1589965820312, 15.876500129699707), interacted = false},
    {position = vec3:new(61.35449981689453, -884.9329833984375, -0.22761300206184387), interacted = false},
    {position = vec3:new(-220.0679931640625, -635.9000244140625, 12.449399948120117), interacted = false},
    {position = vec3:new(-196.97000122070312, -414.3179931640625, 8.473739624023438), interacted = false},
    {position = vec3:new(-96.30960083007812, -349.8919982910156, 9.390979766845703), interacted = false},
    {position = vec3:new(17.704299926757812, -621.177978515625, 4.814909934997559), interacted = false},
    {position = vec3:new(154.28500366210938, -584.3079833984375, 16.04319953918457), interacted = false},
    {position = vec3:new(64.34400177001953, -884.9340209960938, -0.3484809994697571), interacted = false},
    {position = vec3:new(522.1829833984375, -175.87100219726562, 4.956160068511963), interacted = false},
    {position = vec3:new(670.10400390625, -245.91000366210938, 11.248800277709961), interacted = false},
    {position = vec3:new(564.1900024414062, -401.4580078125, 5.1186299324035645), interacted = false},
    {position = vec3:new(434.1319885253906, -414.83099365234375, 7.072289943695068), interacted = false},
    {position = vec3:new(487.7969970703125, -295.1419982910156, 9.950460433959961), interacted = false},
    {position = vec3:new(439.54901123046875, -415.35400390625, 6.522389888763428), interacted = false},
    {position = vec3:new(488.64801025390625, -298.1419982910156, 10.061100006103516), interacted = false},
    {position = vec3:new(524.2969970703125, -173.99600219726562, 5.155449867248535), interacted = false},
    {position = vec3:new(668.166015625, -246.21299743652344, 11.349800109863281), interacted = false},
    {position = vec3:new(565.4320068359375, -399.0050048828125, 5.391670227050781), interacted = false},
    {position = vec3:new(343.7929992675781, -591.8770141601562, 4.710480213165283), interacted = false},
    {position = vec3:new(522.3909912109375, -617.7310180664062, 1.2455099821090698), interacted = false},
    {position = vec3:new(546.0780029296875, -706.6669921875, 0.808542013168335), interacted = false},
    {position = vec3:new(357.3609924316406, -828.6300048828125, -0.47961199283599854), interacted = false},
    {position = vec3:new(197.8459930419922, -784.7360229492188, 10.053299903869629), interacted = false},
    {position = vec3:new(199.46499633789062, -784.177001953125, 10.087800025939941), interacted = false},
    {position = vec3:new(337.4519958496094, -595.8590087890625, 4.215640068054199), interacted = false},
    {position = vec3:new(525.2650146484375, -618.1279907226562, 1.4781099557876587), interacted = false},
    {position = vec3:new(547.9520263671875, -706.5780029296875, 0.8571730256080627), interacted = false},
    {position = vec3:new(361.7179870605469, -827.9829711914062, -0.0037738699465990067), interacted = false},
    {position = vec3:new(198.125, -111.89600372314453, 14.95740032196045), interacted = false},
    {position = vec3:new(353.93701171875, 15.568099975585938, 19.84950065612793), interacted = false},
    {position = vec3:new(283.61199951171875, 59.21630096435547, 20.63719940185547), interacted = false},
    {position = vec3:new(198.26600646972656, -109.13600158691406, 15.885299682617188), interacted = false},
    {position = vec3:new(351.64801025390625, 18.207399368286133, 20.42099952697754), interacted = false},
    {position = vec3:new(284.1520080566406, 57.563899993896484, 20.55929946899414), interacted = false},
    {position = vec3:new(-533.1630249023438, -146.0570068359375, 29.327800750732422), interacted = false},
    {position = vec3:new(-484.09600830078125, 99.25849914550781, 28.266799926757812), interacted = false},
    {position = vec3:new(-332.03399658203125, 29.573699951171875, 22.465700149536133), interacted = false},
    {position = vec3:new(-286.281005859375, -187.36300659179688, 13.789899826049805), interacted = false},
    {position = vec3:new(25.979900360107422, -7.169990062713623, 3.8976900577545166), interacted = false},
    {position = vec3:new(-4.645259857177734, -227.93699645996094, 12.51099967956543), interacted = false},
    {position = vec3:new(-532.968994140625, -144.97500610351562, 29.633800506591797), interacted = false},
    {position = vec3:new(-483.3190002441406, 97.8635025024414, 27.967300415039062), interacted = false},
    {position = vec3:new(-330.5090026855469, 31.44700050354004, 22.080699920654297), interacted = false},
    {position = vec3:new(-6.360380172729492, -225.88999938964844, 12.740400314331055), interacted = false},
    {position = vec3:new(-285.364990234375, -186.24200439453125, 14), interacted = false},
    -- Scosglen
    {position = vec3:new(-2095.81005859375, -1237.199951171875, 1.733430027961731), interacted = false}, -- Scos_CMP_HopesLight (Altar of Lilith).mrk.json
    {position = vec3:new(-2215.449951171875, -376.8609924316406, 4.703770160675049), interacted = false}, -- Scos_CMP_MoordaineLodge (Altar of Lilith).mrk.json
    {position = vec3:new(-1495.3499755859375, -1051.72998046875, 30.144800186157227), interacted = false}, -- Scos_CMP_TurDulra (Altar of Lilith).mrk.json
    {position = vec3:new(-1861.5699462890625, -1136.030029296875, 15.674599647521973), interacted = false}, -- Scos_Coast (Altar of Lilith).mrk.json
    {position = vec3:new(-2095.219970703125, -1021.0800170898438, -1.260159969329834), interacted = false}, -- Scos_Coast (Altar of Lilith).mrk.json
    {position = vec3:new(-1685.489990234375, -1102.5, 10.33590030670166), interacted = false}, -- Scos_Coast (Altar of Lilith).mrk.json
    {position = vec3:new(-2074.89990234375, -1179.9100341796875, -0.31254100799560547), interacted = false}, -- Scos_Coast (Altar of Lilith).mrk.json
    {position = vec3:new(-2068.820068359375, -1182.6500244140625, -0.1614920049905777), interacted = false}, -- Scos_Coast (Altar of Lilith).mrk.json
    {position = vec3:new(-1862.949951171875, -1135.5400390625, 15.696999549865723), interacted = false}, -- Scos_Coast (Altar of Lilith).mrk.json
    {position = vec3:new(-2096.110107421875, -1022.97998046875, -0.697363018989563), interacted = false}, -- Scos_Coast (Altar of Lilith).mrk.json
    {position = vec3:new(-1684.4000244140625, -1101.47998046875, 10.731200218200684), interacted = false}, -- Scos_Coast (Altar of Lilith).mrk.json
    {position = vec3:new(-1538.780029296875, -1100.77001953125, 20.64310073852539), interacted = false}, -- Scos_Deep_Forest (Altar of Lilith).mrk.json
    {position = vec3:new(-1387.25, -918.5549926757812, 39.726600646972656), interacted = false}, -- Scos_Deep_Forest (Altar of Lilith).mrk.json
    {position = vec3:new(-1197.93994140625, -1057.9599609375, 40.32400131225586), interacted = false}, -- Scos_Deep_Forest (Altar of Lilith).mrk.json
    {position = vec3:new(-1538.6099853515625, -1099.8499755859375, 20.737600326538086), interacted = false}, -- Scos_Deep_Forest (Altar of Lilith).mrk.json
    {position = vec3:new(-1385.8599853515625, -919.0540161132812, 39.855098724365234), interacted = false}, -- Scos_Deep_Forest (Altar of Lilith).mrk.json
    {position = vec3:new(-1196.8900146484375, -1057.1199951171875, 40.44919967651367), interacted = false}, -- Scos_Deep_Forest (Altar of Lilith).mrk.json
    {position = vec3:new(-1720.3800048828125, -347.10198974609375, 21.074199676513672), interacted = false}, -- Scos_Downs (Altar of Lilith).mrk.json
    {position = vec3:new(-1872.02001953125, -323.572998046875, 18.580400466918945), interacted = false}, -- Scos_Downs (Altar of Lilith).mrk.json
    {position = vec3:new(-1610.56005859375, -436.0870056152344, 54.5161018371582), interacted = false}, -- Scos_Downs (Altar of Lilith).mrk.json
    {position = vec3:new(-1720.949951171875, -345.73199462890625, 21.248899459838867), interacted = false}, -- Scos_Downs (Altar of Lilith).mrk.json
    {position = vec3:new(-1871.1700439453125, -325.2539978027344, 18.679399490356445), interacted = false}, -- Scos_Downs (Altar of Lilith).mrk.json
    {position = vec3:new(-1609.5699462890625, -432.7080078125, 54.385101318359375), interacted = false}, -- Scos_Downs (Altar of Lilith).mrk.json
    {position = vec3:new(-1958.1400146484375, -120.26300048828125, 36.36479949951172), interacted = false}, -- Scos_Highlands (Altar of Lilith).mrk.json
    {position = vec3:new(-1840.760009765625, -1.0587899684906006, 66.95469665527344), interacted = false}, -- Scos_Highlands (Altar of Lilith).mrk.json
    {position = vec3:new(-1765.1300048828125, -202.89599609375, 29.2898006439209), interacted = false}, -- Scos_Highlands (Altar of Lilith).mrk.json
    {position = vec3:new(-1970.22998046875, 24.799699783325195, 46.772499084472656), interacted = false}, -- Scos_Highlands (Altar of Lilith).mrk.json
    {position = vec3:new(-2186.25, 112.75900268554688, 28.55430030822754), interacted = false}, -- Scos_Highlands (Altar of Lilith).mrk.json
    {position = vec3:new(-2117.570068359375, -42.32720184326172, 24.574499130249023), interacted = false}, -- Scos_Highlands (Altar of Lilith).mrk.json
    {position = vec3:new(-1960.1600341796875, -119.22899627685547, 36.33620071411133), interacted = false}, -- Scos_Highlands (Altar of Lilith).mrk.json
    {position = vec3:new(-1839.4599609375, -0.40213000774383545, 66.7936019897461), interacted = false}, -- Scos_Highlands (Altar of Lilith).mrk.json
    {position = vec3:new(-1765.5899658203125, -201.31300354003906, 29.554000854492188), interacted = false}, -- Scos_Highlands (Altar of Lilith).mrk.json
    {position = vec3:new(-1969.27001953125, 23.84980010986328, 46.74549865722656), interacted = false}, -- Scos_Highlands (Altar of Lilith).mrk.json
    {position = vec3:new(-2185.2900390625, 113.36299896240234, 28.69029998779297), interacted = false}, -- Scos_Highlands (Altar of Lilith).mrk.json
    {position = vec3:new(-2117.2900390625, -41.37879943847656, 24.573400497436523), interacted = false}, -- Scos_Highlands (Altar of Lilith).mrk.json
    {position = vec3:new(-1639.8499755859375, -873.1220092773438, 26.01799964904785), interacted = false}, -- Scos_High_Forest (Altar of Lilith).mrk.json
    {position = vec3:new(-1596.56005859375, -772.3350219726562, 30.303600311279297), interacted = false}, -- Scos_High_Forest (Altar of Lilith).mrk.json
    {position = vec3:new(-1594.4599609375, -482.3139953613281, 44.24800109863281), interacted = false}, -- Scos_High_Forest (Altar of Lilith).mrk.json
    {position = vec3:new(-1639.199951171875, -872.5490112304688, 25.7721004486084), interacted = false}, -- Scos_High_Forest (Altar of Lilith).mrk.json
    {position = vec3:new(-1597, -771.5579833984375, 30.48870086669922), interacted = false}, -- Scos_High_Forest (Altar of Lilith).mrk.json
    {position = vec3:new(-1593.5999755859375, -483.33599853515625, 44.463600158691406), interacted = false}, -- Scos_High_Forest (Altar of Lilith).mrk.json
    {position = vec3:new(-2087.679931640625, -923.3330078125, 28.37700080871582), interacted = false}, -- Scos_Hills (Altar of Lilith).mrk.json
    {position = vec3:new(-1836.030029296875, -667.2000122070312, 21.40239906311035), interacted = false}, -- Scos_Hills (Altar of Lilith).mrk.json
    {position = vec3:new(-2020.9000244140625, -740.2470092773438, 20.306699752807617), interacted = false}, -- Scos_Hills (Altar of Lilith).mrk.json
    {position = vec3:new(-2086.97998046875, -922.5050048828125, 29.010299682617188), interacted = false}, -- Scos_Hills (Altar of Lilith).mrk.json
    {position = vec3:new(-1833.2099609375, -666.2650146484375, 21.562999725341797), interacted = false}, -- Scos_Hills (Altar of Lilith).mrk.json
    {position = vec3:new(-2018.8199462890625, -739.6300048828125, 20.009899139404297), interacted = false}, -- Scos_Hills (Altar of Lilith).mrk.json
    {position = vec3:new(-1435.1199951171875, -747.2919921875, 48.03459930419922), interacted = false}, -- Scos_Lowlands (Altar of Lilith).mrk.json
    {position = vec3:new(-1348.989990234375, -593.2739868164062, 49.360599517822266), interacted = false}, -- Scos_Lowlands (Altar of Lilith).mrk.json
    {position = vec3:new(-1263.1300048828125, -745.822998046875, 44.9109992980957), interacted = false}, -- Scos_Lowlands (Altar of Lilith).mrk.json
    {position = vec3:new(-1434, -747.9669799804688, 48.183998107910156), interacted = false}, -- Scos_Lowlands (Altar of Lilith).mrk.json
    {position = vec3:new(-1349.1300048828125, -597.2030029296875, 49.19459915161133), interacted = false}, -- Scos_Lowlands (Altar of Lilith).mrk.json
    {position = vec3:new(-1263.47998046875, -744.5709838867188, 44.72010040283203), interacted = false}, -- Scos_Lowlands (Altar of Lilith).mrk.json
    {position = vec3:new(-1999.3199462890625, -292.2120056152344, 15.670599937438965), interacted = false}, -- Scos_Moors (Altar of Lilith).mrk.json
    {position = vec3:new(-2243.93994140625, -110.06199645996094, 2.3580100536346436), interacted = false}, -- Scos_Moors (Altar of Lilith).mrk.json
    {position = vec3:new(-2186.469970703125, -58.216800689697266, 12.925800323486328), interacted = false}, -- Scos_Moors (Altar of Lilith).mrk.json
    {position = vec3:new(-1997.719970703125, -291.14599609375, 15.181900024414062), interacted = false}, -- Scos_Moors (Altar of Lilith).mrk.json
    {position = vec3:new(-2244.10009765625, -112.3270034790039, 2.365730047225952), interacted = false}, -- Scos_Moors (Altar of Lilith).mrk.json
    {position = vec3:new(-2188.300048828125, -60.30339813232422, 13.163299560546875), interacted = false}, -- Scos_Moors (Altar of Lilith).mrk.json
    {position = vec3:new(-2104.1298828125, -553.1699829101562, 5.611420154571533), interacted = false}, -- Scos_Strand (Altar of Lilith).mrk.json
    {position = vec3:new(-2207.4599609375, -417.0849914550781, 21.097299575805664), interacted = false}, -- Scos_Strand (Altar of Lilith).mrk.json
    {position = vec3:new(-1906.9000244140625, -536.6090087890625, 19.383499145507812), interacted = false}, -- Scos_Strand (Altar of Lilith).mrk.json
    {position = vec3:new(-2101.610107421875, -553.8319702148438, 5.578360080718994), interacted = false}, -- Scos_Strand (Altar of Lilith).mrk.json
    {position = vec3:new(-2206.610107421875, -416.52099609375, 21.26059913635254), interacted = false}, -- Scos_Strand (Altar of Lilith).mrk.json
    {position = vec3:new(-1906.8199462890625, -535.18701171875, 19.499399185180664), interacted = false}, -- Scos_Strand (Altar of Lilith).mrk.json
    -- Dry Steppes
    {position = vec3:new(-831.0339965820312, -507.2749938964844, 30.667699813842773), interacted = false}, -- Step_Basin (Altar of Lilith).mrk.json
    {position = vec3:new(-853.9669799804688, -310.90399169921875, 48.63869857788086), interacted = false}, -- Step_Basin (Altar of Lilith).mrk.json
    {position = vec3:new(-783.447998046875, -420.10198974609375, 33.93920135498047), interacted = false}, -- Step_Basin (Altar of Lilith).mrk.json
    {position = vec3:new(-829.7369995117188, -505.3389892578125, 30.465599060058594), interacted = false}, -- Step_Basin (Altar of Lilith).mrk.json
    {position = vec3:new(-852.2130126953125, -312.6109924316406, 48.19599914550781), interacted = false}, -- Step_Basin (Altar of Lilith).mrk.json
    {position = vec3:new(-785.822021484375, -420.3890075683594, 34.78229904174805), interacted = false}, -- Step_Basin (Altar of Lilith).mrk.json
    {position = vec3:new(-1149, -762.7579956054688, 24.344200134277344), interacted = false}, -- Step_Central (Altar of Lilith).mrk.json
    {position = vec3:new(-1020.0900268554688, -738.905029296875, 14.719599723815918), interacted = false}, -- Step_Central (Altar of Lilith).mrk.json
    {position = vec3:new(-766.583984375, -573.3369750976562, 15.664600372314453), interacted = false}, -- Step_Central (Altar of Lilith).mrk.json
    {position = vec3:new(-771.9420166015625, -752.2680053710938, 35.92490005493164), interacted = false}, -- Step_Central (Altar of Lilith).mrk.json
    {position = vec3:new(-1149.8599853515625, -764.3150024414062, 24.42140007019043), interacted = false}, -- Step_Central (Altar of Lilith).mrk.json
    {position = vec3:new(-769.1229858398438, -571.5269775390625, 15.700599670410156), interacted = false}, -- Step_Central (Altar of Lilith).mrk.json
    {position = vec3:new(-770.7249755859375, -752.2680053710938, 36.264198303222656), interacted = false}, -- Step_Central (Altar of Lilith).mrk.json
    {position = vec3:new(-1027.239990234375, -844.5089721679688, -16.040199279785156), interacted = false}, -- Step_CentralCanyon (Altar of Lilith).mrk.json
    {position = vec3:new(-963.510986328125, -834.60400390625, 3.233409881591797), interacted = false}, -- Step_CentralCanyon (Altar of Lilith).mrk.json
    {position = vec3:new(-961.4390258789062, -834.3319702148438, 3.0336499214172363), interacted = false}, -- Step_CentralCanyon (Altar of Lilith).mrk.json
    {position = vec3:new(-577.6110229492188, -1169.72998046875, 3.2789499759674072), interacted = false}, -- Step_Coast (Altar of Lilith).mrk.json
    {position = vec3:new(-450.44500732421875, -1006.3599853515625, 23.81800079345703), interacted = false}, -- Step_Coast (Altar of Lilith).mrk.json
    {position = vec3:new(-269.4859924316406, -1169.8299560546875, -0.1647309958934784), interacted = false}, -- Step_Coast (Altar of Lilith).mrk.json
    {position = vec3:new(-132.322998046875, -1009.489990234375, 18.384599685668945), interacted = false}, -- Step_Coast (Altar of Lilith).mrk.json
    {position = vec3:new(-574.916015625, -1169.5799560546875, 3.085510015487671), interacted = false}, -- Step_Coast (Altar of Lilith).mrk.json
    {position = vec3:new(-447.1839904785156, -1006.9000244140625, 23.768299102783203), interacted = false}, -- Step_Coast (Altar of Lilith).mrk.json
    {position = vec3:new(-268.0660095214844, -1168.1300048828125, -0.08354759961366653), interacted = false}, -- Step_Coast (Altar of Lilith).mrk.json
    {position = vec3:new(-132.14500427246094, -1012.22998046875, 18.462099075317383), interacted = false}, -- Step_Coast (Altar of Lilith).mrk.json
    {position = vec3:new(-869.4030151367188, -193.9669952392578, 51.41490173339844), interacted = false}, -- Step_Eastern (Altar of Lilith).mrk.json
    {position = vec3:new(-802.7340087890625, -306.7760009765625, 57.15829849243164), interacted = false}, -- Step_Eastern (Altar of Lilith).mrk.json
    {position = vec3:new(-866.6199951171875, -193.5850067138672, 51.86040115356445), interacted = false}, -- Step_Eastern (Altar of Lilith).mrk.json
    {position = vec3:new(-802.1160278320312, -304.1130065917969, 57.669498443603516), interacted = false}, -- Step_Eastern (Altar of Lilith).mrk.json
    {position = vec3:new(-951.8079833984375, -869.4130249023438, 1.4190900325775146), interacted = false}, -- Step_Grassland (Altar of Lilith).mrk.json
    {position = vec3:new(-812.6599731445312, -874.3989868164062, 19.720500946044922), interacted = false}, -- Step_Grassland (Altar of Lilith).mrk.json
    {position = vec3:new(-1139.0400390625, -1088.260009765625, 0.10142199695110321), interacted = false}, -- Step_Grassland (Altar of Lilith).mrk.json
    {position = vec3:new(-771.4829711914062, -1034.9200439453125, 2.997770071029663), interacted = false}, -- Step_Grassland (Altar of Lilith).mrk.json
    {position = vec3:new(-1136.3900146484375, -1090.989990234375, 0.1988849937915802), interacted = false}, -- Step_Grassland (Altar of Lilith).mrk.json
    {position = vec3:new(-814.3300170898438, -874.1669921875, 19.675199508666992), interacted = false}, -- Step_Grassland (Altar of Lilith).mrk.json
    {position = vec3:new(-770.5700073242188, -1036.800048828125, 3.073430061340332), interacted = false}, -- Step_Grassland (Altar of Lilith).mrk.json
    {position = vec3:new(-816.5230102539062, -681.458984375, 39.79600143432617), interacted = false}, -- Step_OnyxWatchtower (Altar of Lilith).mrk.json
    {position = vec3:new(-200.47799682617188, -837.1699829101562, 25.24449920654297), interacted = false}, -- Step_PvP (Altar of Lilith).mrk.json
    {position = vec3:new(-200.32400512695312, -837.6389770507812, 25.41010093688965), interacted = false}, -- Step_PvP (Altar of Lilith).mrk.json
    {position = vec3:new(-702.156005859375, -93.82440185546875, 52.34260177612305), interacted = false}, -- Step_QaraYisu (Altar of Lilith).mrk.json
    {position = vec3:new(-650.0419921875, -614.3720092773438, 40.46160125732422), interacted = false}, -- Step_South (Altar of Lilith).mrk.json
    {position = vec3:new(-544.9329833984375, -507.0159912109375, 45.0629997253418), interacted = false}, -- Step_South (Altar of Lilith).mrk.json
    {position = vec3:new(-318.85400390625, -591.0770263671875, 40.19729995727539), interacted = false}, -- Step_South (Altar of Lilith).mrk.json
    {position = vec3:new(-469.5459899902344, -412.3970031738281, 47.454200744628906), interacted = false}, -- Step_South (Altar of Lilith).mrk.json
    {position = vec3:new(-471.2929992675781, -410.6029968261719, 47.439998626708984), interacted = false}, -- Step_South (Altar of Lilith).mrk.json
    {position = vec3:new(-544.5809936523438, -504.6910095214844, 45.37110137939453), interacted = false}, -- Step_South (Altar of Lilith).mrk.json
    {position = vec3:new(-317.4649963378906, -591.2670288085938, 40.34450149536133), interacted = false}, -- Step_South (Altar of Lilith).mrk.json
    {position = vec3:new(-479.00299072265625, -629.2340087890625, 50.36000061035156), interacted = false}, -- Step_TempleOfRot (Altar of Lilith).mrk.json
    {position = vec3:new(-1209.9200439453125, -509.89300537109375, 55.19459915161133), interacted = false}, -- Step_Volcano (Altar of Lilith).mrk.json
    {position = vec3:new(-1131.219970703125, -372.0979919433594, 51.53179931640625), interacted = false}, -- Step_Volcano (Altar of Lilith).mrk.json
    {position = vec3:new(-1021.489990234375, -419.0570068359375, 52.45790100097656), interacted = false}, -- Step_Volcano (Altar of Lilith).mrk.json
    {position = vec3:new(-1208.3599853515625, -508.2099914550781, 55.29520034790039), interacted = false}, -- Step_Volcano (Altar of Lilith).mrk.json
    {position = vec3:new(-1129.550048828125, -370.41400146484375, 51.799800872802734), interacted = false}, -- Step_Volcano (Altar of Lilith).mrk.json
    {position = vec3:new(-1023.9000244140625, -421.76300048828125, 51.69309997558594), interacted = false}, -- Step_Volcano (Altar of Lilith).mrk.json
    {position = vec3:new(-632.8930053710938, -968.7410278320312, 8.683819770812988), interacted = false}, -- Step_WesternFlats (Altar of Lilith).mrk.json
    {position = vec3:new(-608.406005859375, -816.385009765625, 9.84000015258789), interacted = false}, -- Step_WesternFlats (Altar of Lilith).mrk.json
    {position = vec3:new(-734.2030029296875, -822.4080200195312, 34.7411994934082), interacted = false}, -- Step_WesternFlats (Altar of Lilith).mrk.json
    {position = vec3:new(-633.0910034179688, -966.6339721679688, 8.941370010375977), interacted = false}, -- Step_WesternFlats (Altar of Lilith).mrk.json
    {position = vec3:new(-733.0070190429688, -823.2659912109375, 34.968299865722656), interacted = false}, -- Step_WesternFlats (Altar of Lilith).mrk.json
    {position = vec3:new(-607.4349975585938, -817.1110229492188, 9.573470115661621), interacted = false}, -- Step_WesternFlats (Altar of Lilith).mrk.json
    -- Fractured Peaks
    {position = vec3:new(-1504.8900146484375, 439.7919921875, 73.9800033569336), interacted = false}, -- Frac_GaleValley (Altar of Lilith).mrk.json
    {position = vec3:new(-1380.7900390625, 647.9760131835938, 57.402400970458984), interacted = false}, -- Frac_GaleValley (Altar of Lilith).mrk.json
    {position = vec3:new(-1520.780029296875, 617.1420288085938, 61.4093017578125), interacted = false}, -- Frac_GaleValley (Altar of Lilith).mrk.json
    {position = vec3:new(-1504.3199462890625, 439.3580017089844, 73.82479858398438), interacted = false}, -- Frac_GaleValley (Altar of Lilith).mrk.json
    {position = vec3:new(-1379.8299560546875, 647.322021484375, 57.35409927368164), interacted = false}, -- Frac_GaleValley (Altar of Lilith).mrk.json
    {position = vec3:new(-1520.739990234375, 618.5449829101562, 61.63710021972656), interacted = false}, -- Frac_GaleValley (Altar of Lilith).mrk.json
    {position = vec3:new(-1886.969970703125, 251.9340057373047, 105.39099884033203), interacted = false}, -- Frac_Glacier (Altar of Lilith).mrk.json
    {position = vec3:new(-1855.1099853515625, 546.4310302734375, 112.7979965209961), interacted = false}, -- Frac_Glacier (Altar of Lilith).mrk.json
    {position = vec3:new(-1773.1600341796875, 450.0570068359375, 114.81300354003906), interacted = false}, -- Frac_Glacier (Altar of Lilith).mrk.json
    {position = vec3:new(-1886.1099853515625, 252.0489959716797, 105.5780029296875), interacted = false}, -- Frac_Glacier (Altar of Lilith).mrk.json
    {position = vec3:new(-1854.1500244140625, 546.52001953125, 112.7239990234375), interacted = false}, -- Frac_Glacier (Altar of Lilith).mrk.json
    {position = vec3:new(-1776.449951171875, 450.22198486328125, 114.95800018310547), interacted = false}, -- Frac_Glacier (Altar of Lilith).mrk.json
    {position = vec3:new(-1561.5699462890625, -122.4209976196289, 112.93000030517578), interacted = false}, -- Frac_KorDragan (Altar of Lilith).mrk.json
    {position = vec3:new(-1601.7900390625, 410.2300109863281, 95.51609802246094), interacted = false}, -- Frac_Malnok (Altar of Lilith).mrk.json
    {position = vec3:new(-1139.6400146484375, -9.606829643249512, 103.66000366210938), interacted = false}, -- Frac_Nostrava (Altar of Lilith).mrk.json
    {position = vec3:new(-1294.5799560546875, 393.5050048828125, 76.44650268554688), interacted = false}, -- Frac_Taiga_E (Altar of Lilith).mrk.json
    {position = vec3:new(-1159.8399658203125, 371.5469970703125, 59.19660186767578), interacted = false}, -- Frac_Taiga_E (Altar of Lilith).mrk.json
    {position = vec3:new(-1328.1400146484375, 206.4459991455078, 84.83039855957031), interacted = false}, -- Frac_Taiga_E (Altar of Lilith).mrk.json
    {position = vec3:new(-1329.260009765625, 209.13900756835938, 84.50460052490234), interacted = false}, -- Frac_Taiga_E (Altar of Lilith).mrk.json
    {position = vec3:new(-1292.3599853515625, 393.61199951171875, 76.23770141601562), interacted = false}, -- Frac_Taiga_E (Altar of Lilith).mrk.json
    {position = vec3:new(-1158.68994140625, 370.8280029296875, 59.368499755859375), interacted = false}, -- Frac_Taiga_E (Altar of Lilith).mrk.json
    {position = vec3:new(-940.5999755859375, 92.83550262451172, 77.43419647216797), interacted = false}, -- Frac_Taiga_S (Altar of Lilith).mrk.json
    {position = vec3:new(-1261.7099609375, 111.4209976196289, 73.64620208740234), interacted = false}, -- Frac_Taiga_S (Altar of Lilith).mrk.json
    {position = vec3:new(-1241.1500244140625, 209.30799865722656, 94.1178970336914), interacted = false}, -- Frac_Taiga_S (Altar of Lilith).mrk.json
    {position = vec3:new(-939.6580200195312, 95.1697006225586, 77.54609680175781), interacted = false}, -- Frac_Taiga_S (Altar of Lilith).mrk.json
    {position = vec3:new(-1261.3900146484375, 113.36499786376953, 73.60990142822266), interacted = false}, -- Frac_Taiga_S (Altar of Lilith).mrk.json
    {position = vec3:new(-1239.5, 208.61000061035156, 94.21009826660156), interacted = false}, -- Frac_Taiga_S (Altar of Lilith).mrk.json
    {position = vec3:new(-1307.300048828125, -184.55799865722656, 101.36799621582031), interacted = false}, -- Frac_Taiga_W (Altar of Lilith).mrk.json
    {position = vec3:new(-1244.0999755859375, 68.49340057373047, 95.33370208740234), interacted = false}, -- Frac_Taiga_W (Altar of Lilith).mrk.json
    {position = vec3:new(-960.9459838867188, 0.9750249981880188, 75.83660125732422), interacted = false}, -- Frac_Taiga_W (Altar of Lilith).mrk.json
    {position = vec3:new(-1308.5899658203125, -183.11900329589844, 101.39299774169922), interacted = false}, -- Frac_Taiga_W (Altar of Lilith).mrk.json
    {position = vec3:new(-1246.4200439453125, 66.54609680175781, 95.28309631347656), interacted = false}, -- Frac_Taiga_W (Altar of Lilith).mrk.json
    {position = vec3:new(-961.7039794921875, 2.0836501121520996, 76), interacted = false}, -- Frac_Taiga_W (Altar of Lilith).mrk.json
    {position = vec3:new(-1637.199951171875, 88.75199890136719, 113.14600372314453), interacted = false}, -- Frac_Tundra_N (Altar of Lilith).mrk.json
    {position = vec3:new(-1543.2900390625, 128.88099670410156, 111.41699981689453), interacted = false}, -- Frac_Tundra_N (Altar of Lilith).mrk.json
    {position = vec3:new(-1592.8800048828125, 274.3219909667969, 98.68890380859375), interacted = false}, -- Frac_Tundra_N (Altar of Lilith).mrk.json
    {position = vec3:new(-1536.68994140625, 399.25299072265625, 90.76750183105469), interacted = false}, -- Frac_Tundra_N (Altar of Lilith).mrk.json
    {position = vec3:new(-1649.5799560546875, 543.2249755859375, 85.05919647216797), interacted = false}, -- Frac_Tundra_N (Altar of Lilith).mrk.json
    {position = vec3:new(-1635, 87.89350128173828, 113.09200286865234), interacted = false}, -- Frac_Tundra_N (Altar of Lilith).mrk.json
    {position = vec3:new(-1542.93994140625, 129.79200744628906, 111.55599975585938), interacted = false}, -- Frac_Tundra_N (Altar of Lilith).mrk.json
    {position = vec3:new(-1594.3900146484375, 275.2969970703125, 98.71479797363281), interacted = false}, -- Frac_Tundra_N (Altar of Lilith).mrk.json
    {position = vec3:new(-1534.25, 398.781005859375, 91.06890106201172), interacted = false}, -- Frac_Tundra_N (Altar of Lilith).mrk.json
    {position = vec3:new(-1650.8699951171875, 544.1389770507812, 84.9135971069336), interacted = false}, -- Frac_Tundra_N (Altar of Lilith).mrk.json
    {position = vec3:new(-1562.719970703125, 6.541659832000732, 112.65899658203125), interacted = false}, -- Frac_Tundra_S (Altar of Lilith).mrk.json
    {position = vec3:new(-1493.27001953125, -208.9080047607422, 98.09860229492188), interacted = false}, -- Frac_Tundra_S (Altar of Lilith).mrk.json
    {position = vec3:new(-1369.68994140625, -69.97979736328125, 97.3904037475586), interacted = false}, -- Frac_Tundra_S (Altar of Lilith).mrk.json
    {position = vec3:new(-1371.68994140625, -272.6080017089844, 99.1592025756836), interacted = false}, -- Frac_Tundra_S (Altar of Lilith).mrk.json
    {position = vec3:new(-1565.1199951171875, 7.692930221557617, 114.23999786376953), interacted = false}, -- Frac_Tundra_S (Altar of Lilith).mrk.json
    {position = vec3:new(-1493.6400146484375, -207.28500366210938, 97.84259796142578), interacted = false}, -- Frac_Tundra_S (Altar of Lilith).mrk.json
    {position = vec3:new(-1370.47998046875, -69.05840301513672, 97.0730972290039), interacted = false}, -- Frac_Tundra_S (Altar of Lilith).mrk.json
    {position = vec3:new(-1372.77001953125, -272.3550109863281, 99.02570343017578), interacted = false}, -- Frac_Tundra_S (Altar of Lilith).mrk.json
    -- Hawezar
    {position = vec3:new(-1099.8499755859375, 833.0560302734375, -0.025835400447249413), interacted = false}, -- Hawe_Bog (Altar of Lilith).mrk.json
    {position = vec3:new(-1270.219970703125, 688.6439819335938, -0.07160220295190811), interacted = false}, -- Hawe_Bog (Altar of Lilith).mrk.json
    {position = vec3:new(-1152.530029296875, 654.8090209960938, -0.1999959945678711), interacted = false}, -- Hawe_Bog (Altar of Lilith).mrk.json
    {position = vec3:new(-1257.43994140625, 766.864013671875, 0.021203799173235893), interacted = false}, -- Hawe_Bog (Altar of Lilith).mrk.json
    {position = vec3:new(-1097.6600341796875, 832.6900024414062, -0.024790499359369278), interacted = false}, -- Hawe_Bog (Altar of Lilith).mrk.json
    {position = vec3:new(-1268.6800537109375, 688.8099975585938, 0.030620599165558815), interacted = false}, -- Hawe_Bog (Altar of Lilith).mrk.json
    {position = vec3:new(-1150.3900146484375, 656.2449951171875, -0.19999699294567108), interacted = false}, -- Hawe_Bog (Altar of Lilith).mrk.json
    {position = vec3:new(-1254.6300048828125, 768.2160034179688, 0.07022230327129364), interacted = false}, -- Hawe_Bog (Altar of Lilith).mrk.json
    {position = vec3:new(-537.906005859375, 149.78599548339844, 43.14400100708008), interacted = false}, -- Hawe_Camp_03 (Altar of Lilith).mrk.json
    {position = vec3:new(-715.614013671875, 1152, -0.29369598627090454), interacted = false}, -- Hawe_Coast (Altar of Lilith).mrk.json
    {position = vec3:new(-876.9210205078125, 1088.8399658203125, -0.33705100417137146), interacted = false}, -- Hawe_Coast (Altar of Lilith).mrk.json
    {position = vec3:new(-714.7100219726562, 1360.3800048828125, -0.2361299991607666), interacted = false}, -- Hawe_Coast (Altar of Lilith).mrk.json
    {position = vec3:new(-715.5850219726562, 1152.9599609375, -0.07250069826841354), interacted = false}, -- Hawe_Coast (Altar of Lilith).mrk.json
    {position = vec3:new(-875.4459838867188, 1089.7099609375, -0.20127199590206146), interacted = false}, -- Hawe_Coast (Altar of Lilith).mrk.json
    {position = vec3:new(-712.2949829101562, 1360.7099609375, 0.0702366977930069), interacted = false}, -- Hawe_Coast (Altar of Lilith).mrk.json
    {position = vec3:new(-332.5400085449219, 293.9389953613281, 46.73979949951172), interacted = false}, -- Hawe_Crossway (Altar of Lilith).mrk.json
    {position = vec3:new(-348.68701171875, 489.3869934082031, 23.155000686645508), interacted = false}, -- Hawe_Crossway (Altar of Lilith).mrk.json
    {position = vec3:new(-66.05390167236328, 454.79998779296875, 36.42399978637695), interacted = false}, -- Hawe_Crossway (Altar of Lilith).mrk.json
    {position = vec3:new(-101.3280029296875, 247.97999572753906, 29.49139976501465), interacted = false}, -- Hawe_Crossway (Altar of Lilith).mrk.json
    {position = vec3:new(-330.9939880371094, 296.12298583984375, 46.86470031738281), interacted = false}, -- Hawe_Crossway (Altar of Lilith).mrk.json
    {position = vec3:new(-349.0950012207031, 491.13299560546875, 23.32159996032715), interacted = false}, -- Hawe_Crossway (Altar of Lilith).mrk.json
    {position = vec3:new(-65.26899719238281, 456.1239929199219, 36.88420104980469), interacted = false}, -- Hawe_Crossway (Altar of Lilith).mrk.json
    {position = vec3:new(-100.41600036621094, 249.42999267578125, 29.55459976196289), interacted = false}, -- Hawe_Crossway (Altar of Lilith).mrk.json
    {position = vec3:new(-565.8909912109375, 1027.31005859375, 2.2148799896240234), interacted = false}, -- Hawe_Fens (Altar of Lilith).mrk.json
    {position = vec3:new(-485.87298583984375, 1082.02001953125, 0.8351989984512329), interacted = false}, -- Hawe_Fens (Altar of Lilith).mrk.json
    {position = vec3:new(-344.4150085449219, 913.9860229492188, 0.023766599595546722), interacted = false}, -- Hawe_Fens (Altar of Lilith).mrk.json
    {position = vec3:new(-415.0220031738281, 856.4970092773438, 0.2074429988861084), interacted = false}, -- Hawe_Fens (Altar of Lilith).mrk.json
    {position = vec3:new(-561.89697265625, 1029.5899658203125, 3.752239942550659), interacted = false}, -- Hawe_Fens (Altar of Lilith).mrk.json
    {position = vec3:new(-485.5580139160156, 1080.489990234375, 1.0981999635696411), interacted = false}, -- Hawe_Fens (Altar of Lilith).mrk.json
    {position = vec3:new(-346.385986328125, 915.4609985351562, 0.005650040227919817), interacted = false}, -- Hawe_Fens (Altar of Lilith).mrk.json
    {position = vec3:new(-412.8909912109375, 854.5579833984375, 0.8186190128326416), interacted = false}, -- Hawe_Fens (Altar of Lilith).mrk.json
    {position = vec3:new(-1198.3299560546875, 483.61199951171875, 23.02280044555664), interacted = false}, -- Hawe_KeironsPyre (Altar of Lilith).mrk.json
    {position = vec3:new(-985.6220092773438, 803.2919921875, -0.2230280041694641), interacted = false}, -- Hawe_Marsh (Altar of Lilith).mrk.json
    {position = vec3:new(-798.9010009765625, 850.9530029296875, 0.03548840060830116), interacted = false}, -- Hawe_Marsh (Altar of Lilith).mrk.json
    {position = vec3:new(-928.2069702148438, 660.197998046875, 0.15367600321769714), interacted = false}, -- Hawe_Marsh (Altar of Lilith).mrk.json
    {position = vec3:new(-772.3880004882812, 998.635009765625, -0.4055359959602356), interacted = false}, -- Hawe_Marsh (Altar of Lilith).mrk.json
    {position = vec3:new(-985.0189819335938, 806.0139770507812, -0.18099699914455414), interacted = false}, -- Hawe_Marsh (Altar of Lilith).mrk.json
    {position = vec3:new(-797.4530029296875, 850.5989990234375, 0.15708200633525848), interacted = false}, -- Hawe_Marsh (Altar of Lilith).mrk.json
    {position = vec3:new(-926.4609985351562, 661.8519897460938, -0.03524110093712807), interacted = false}, -- Hawe_Marsh (Altar of Lilith).mrk.json
    {position = vec3:new(-775.52099609375, 998.9180297851562, -0.2647959887981415), interacted = false}, -- Hawe_Marsh (Altar of Lilith).mrk.json
    {position = vec3:new(-548.6630249023438, 934.6810302734375, 0.28829100728034973), interacted = false}, -- Hawe_SnakeCultist (Altar of Lilith).mrk.json
    {position = vec3:new(-546.3191528320312, 931.1488647460938, 1.4587899446487427), interacted = false}, -- Hawe_SnakeCultist (Altar of Lilith).mrk.json
    {position = vec3:new(-1109.3699951171875, 389.4429931640625, 31.541500091552734), interacted = false}, -- Hawe_Verge (Altar of Lilith).mrk.json
    {position = vec3:new(-1002.5599975585938, 571.6510009765625, -0.2587440013885498), interacted = false}, -- Hawe_Verge (Altar of Lilith).mrk.json
    {position = vec3:new(-833.531982421875, 554.8250122070312, -0.24689200520515442), interacted = false}, -- Hawe_Verge (Altar of Lilith).mrk.json
    {position = vec3:new(-892.583984375, 295.27398681640625, 14.344900131225586), interacted = false}, -- Hawe_Verge (Altar of Lilith).mrk.json
    {position = vec3:new(-1109.47998046875, 388.0899963378906, 31.650699615478516), interacted = false}, -- Hawe_Verge (Altar of Lilith).mrk.json
    {position = vec3:new(-1002.4000244140625, 575.4920043945312, -0.20018300414085388), interacted = false}, -- Hawe_Verge (Altar of Lilith).mrk.json
    {position = vec3:new(-834.14501953125, 552.4920043945312, -0.19999900460243225), interacted = false}, -- Hawe_Verge (Altar of Lilith).mrk.json
    {position = vec3:new(-893.3289794921875, 296.5899963378906, 14.417400360107422), interacted = false}, -- Hawe_Verge (Altar of Lilith).mrk.json
    {position = vec3:new(-627.9769897460938, 682.7410278320312, -0.2030559927225113), interacted = false}, -- Hawe_Wetland (Altar of Lilith).mrk.json
    {position = vec3:new(-513.7739868164062, 717.489013671875, 4.410409927368164), interacted = false}, -- Hawe_Wetland (Altar of Lilith).mrk.json
    {position = vec3:new(-333.3070068359375, 683.2150268554688, 15.26729965209961), interacted = false}, -- Hawe_Wetland (Altar of Lilith).mrk.json
    {position = vec3:new(-205.39999389648438, 758.510986328125, 10.747400283813477), interacted = false}, -- Hawe_Wetland (Altar of Lilith).mrk.json
    {position = vec3:new(-629.530029296875, 682.5440063476562, 0.5655239820480347), interacted = false}, -- Hawe_Wetland (Altar of Lilith).mrk.json
    {position = vec3:new(-510.5530090332031, 716.7739868164062, 4.540500164031982), interacted = false}, -- Hawe_Wetland (Altar of Lilith).mrk.json
    {position = vec3:new(-334.7760009765625, 686.3839721679688, 15.054699897766113), interacted = false}, -- Hawe_Wetland (Altar of Lilith).mrk.json
    {position = vec3:new(-207.04800415039062, 760.7030029296875, 10.042099952697754), interacted = false}, -- Hawe_Wetland (Altar of Lilith).mrk.json
    {position = vec3:new(-780.0469970703125, 577.114990234375, 21.35890007019043), interacted = false}, -- Hawe_ZakFort (Altar of Lilith).mrk.json
}

local function get_nearest_lilith_altar()
    local player_pos = get_player_position()
    local nearest_pos = nil
    local nearest_dist = math.huge

    for _, pos in pairs(altar_table) do
        if not pos.interacted then
            local dist = pos.position:dist_to_ignore_z(player_pos)
            if dist < nearest_dist then
                nearest_dist = dist
                nearest_pos = pos
            end
        else
            -- console.print("skip bl")
        end
    end

    return nearest_pos
end

local last_waypoint_index = 1
pathfinder.set_last_waypoint_index(1)
local function get_next_waypoint(current_pos, waypoint_table, threshold)

    if true then
        return pathfinder.get_next_waypoint(current_pos, waypoint_table, threshold)
    end

    local player_position = current_pos

    local best_index = nil
    local best_score = math.huge
    local min_distance_sq = threshold * threshold


    local current_node = waypoint_table[last_waypoint_index]
    local current_node_dist_sqr = 0.0
    if current_node then
        current_node_dist_sqr = current_node:squared_dist_to(player_position)
    end
    for i, _waypoint in ipairs(waypoint_table) do

        local is_non_reach_exception = current_node_dist_sqr > (3.0 *3.0) and i == last_waypoint_index
        if i <= last_waypoint_index and not is_non_reach_exception then
            goto continue
        end

        local waypoint = utility.set_height_of_valid_position(_waypoint)
        local distance_sq = player_position:squared_dist_to_ignore_z(waypoint)

        local exp = last_waypoint_index <= 1 and i > last_waypoint_index + 10 and current_node_dist_sqr < (10.0*10.0)
        if distance_sq < min_distance_sq or exp then
            goto continue
        end

        if i > last_waypoint_index + 20 then
            goto continue
        end

        local angle = 0.0
        if last_waypoint_index > 5 then
            angle = waypoint_table[last_waypoint_index - 2]:get_angle(waypoint_table[last_waypoint_index], _waypoint)
        end

        if angle < 90 or i < 15 then
            local score = distance_sq + angle
            if score < best_score then
                best_index = i
                best_score = score
            end
        end

        ::continue::
    end

    if not best_index then
        -- console.print("No valid next waypoint found.")
        return nil
    end

    last_waypoint_index = best_index

    local next_waypoint = utility.set_height_of_valid_position(waypoint_table[best_index])
    return next_waypoint
end

local last_waypoint_index_lilith = 1
local function get_next_waypoint_lilith(current_pos, waypoint_table, threshold)

    local player_position = current_pos

    local best_index = nil
    local best_score = math.huge
    local min_distance_sq = threshold * threshold


    local current_node = waypoint_table[last_waypoint_index_lilith]
    local current_node_dist_sqr = 0.0
    if current_node then
        current_node_dist_sqr = current_node:squared_dist_to(player_position)
    end
    
    for i, _waypoint in ipairs(waypoint_table) do

        local is_non_reach_exception = current_node_dist_sqr > (3.0 *3.0) and i == last_waypoint_index_lilith
        if i <= last_waypoint_index_lilith and not is_non_reach_exception then
            goto continue
        end

        local waypoint = utility.set_height_of_valid_position(_waypoint)
        local distance_sq = player_position:squared_dist_to(waypoint)

        local exp = last_waypoint_index_lilith <= 1 and i > last_waypoint_index_lilith + 10
        if distance_sq < min_distance_sq or exp then
            goto continue
        end

        local angle = 0.0
        if last_waypoint_index_lilith > 5 then
            angle = waypoint_table[last_waypoint_index_lilith - 2]:get_angle(waypoint_table[last_waypoint_index_lilith], _waypoint)
        end

        if angle < 90 or i < 15 then
            local score = distance_sq + angle
            if score < best_score then
                best_index = i
                best_score = score
            end
        end

        ::continue::
    end

    if not best_index then
        -- console.print("No valid next waypoint found.")
        return nil
    end

    last_waypoint_index_lilith = best_index

    local next_waypoint = utility.set_height_of_valid_position(waypoint_table[best_index])
    return next_waypoint
end

local last_waypoint_index_stuck = 1
local function get_next_waypoint_stuck(current_pos, waypoint_table, threshold)

    local player_position = current_pos

    local best_index = nil
    local best_score = math.huge
    local min_distance_sq = threshold * threshold


    local current_node = waypoint_table[last_waypoint_index_stuck]
    local current_node_dist_sqr = 0.0
    if current_node then
        current_node_dist_sqr = current_node:squared_dist_to(player_position)
    end
    
    for i, _waypoint in ipairs(waypoint_table) do

        local is_non_reach_exception = current_node_dist_sqr > (3.0 *3.0) and i == last_waypoint_index_stuck
        if i <= last_waypoint_index_stuck and not is_non_reach_exception then
            goto continue
        end

        local waypoint = utility.set_height_of_valid_position(_waypoint)
        local distance_sq = player_position:squared_dist_to(waypoint)

        local exp = last_waypoint_index_stuck <= 1 and i > last_waypoint_index_stuck + 10
        if distance_sq < min_distance_sq or exp then
            goto continue
        end

        local angle = 0.0
        if last_waypoint_index_stuck > 5 then
            angle = waypoint_table[last_waypoint_index_stuck - 2]:get_angle(waypoint_table[last_waypoint_index_stuck], _waypoint)
        end

        if angle < 90 or i < 15 then
            local score = distance_sq + angle
            if score < best_score then
                best_index = i
                best_score = score
            end
        end

        ::continue::
    end

    if not best_index then
        -- console.print("No valid next waypoint found.")
        return nil
    end

    last_waypoint_index_stuck = best_index

    local next_waypoint = utility.set_height_of_valid_position(waypoint_table[best_index])
    return next_waypoint
end

local waypoints = {}
local last_update_time = 0
local update_interval = 1
local goal = nil
local last_goal = nil

local menu_elements = {
    main_tree = tree_node:new(0),
    enable_plugin = checkbox:new(true, get_hash("enable_plugin_id_qqt_idk_test_lilith")),
    toggle_plugin = keybind:new(0x46, true, get_hash("developer_id_qqt_idk_test_lilith_mode_toggle")) -- F default
}

on_render_menu(function()
    if menu_elements.main_tree:push("Lilith Collector") then
        menu_elements.enable_plugin:render("Enable Plugin", "Toggle to enable or disable the plugin.")
        menu_elements.toggle_plugin:render("Toggle Plugin Keybind", "Set a key to toggle the plugin on or off.")

        menu_elements.main_tree:pop()
    end
end)

local function sort_positions(positions)

    -- if true then
    --     pathfinder.sort_waypoints(positions, positions[1])
    -- end

    local sorted_positions = {}
    local used_indices = {}
    local original_indices = {}

    -- Insert the first position
    table.insert(sorted_positions, positions[1])
    table.insert(original_indices, 1)
    used_indices[1] = true

    -- Iterate through all positions to find the closest unused position
    while #sorted_positions < #positions do
        local nearest_index = nil
        local nearest_distance = math.huge  -- Should be large to start with

        for i, pos in ipairs(positions) do
            if not used_indices[i] then
                local dist_sqr = sorted_positions[#sorted_positions]:squared_dist_to_ignore_z(pos)
                if dist_sqr < nearest_distance then
                    nearest_distance = dist_sqr
                    nearest_index = i
                end
            end
        end

        if nearest_index then
            table.insert(sorted_positions, positions[nearest_index])
            table.insert(original_indices, nearest_index)
            used_indices[nearest_index] = true
        else
            break -- In case something goes wrong or no usable points are left
        end
    end

    -- Post-process to detect and remove outliers
    -- local i = 1
    -- while i <= #sorted_positions - 1 do
    --     if original_indices[i] > #positions * 0.9 and i < #sorted_positions * 0.9 then
    --         -- Check distance to next and previous points to confirm outlier status
    --         local next_dist = sorted_positions[i]:squared_dist_to_ignore_z(sorted_positions[i + 1])
    --         local prev_dist = i > 1 and sorted_positions[i]:squared_dist_to_ignore_z(sorted_positions[i - 1]) or nil

    --         -- Define a threshold for what you consider a significant jump
    --         local distance_threshold = 5000 -- Define this based on your dataset characteristics

    --         if (prev_dist and prev_dist > distance_threshold) and next_dist > distance_threshold then
    --             table.remove(sorted_positions, i)
    --             table.remove(original_indices, i)
    --             -- Do not increment i to check the new current index in the next loop iteration
    --         else
    --             i = i + 1
    --         end
    --     else
    --         i = i + 1
    --     end
    -- end

    return sorted_positions
end

on_update(function()
    local current_time = get_time_since_inject()
    if current_time - last_update_time < update_interval then
        return
    end

    -- console.print("menu_elements.toggle_plugin:get_state() " .. tostring(menu_elements.toggle_plugin:get_state()))
    if not menu_elements.enable_plugin:get() or menu_elements.toggle_plugin:get_state() <= 0 then
        return  -- Abort if the plugin is disabled or the toggle keybind is not active
    end

    if not goal or goal.interacted then
        goal = get_nearest_lilith_altar()
    end

    if not goal then
        return
    end

    if not last_goal or last_goal ~= goal then
        pathfinder.clear_stored_path()
        utility.set_map_pin(goal.position)
        waypoints = pathfinder.create_path_game_engine(goal.position) -- (1 should be always nearest to me)
        console.print("create_path_game_engine called")

        -- console.print(#waypoints)
        if #waypoints > 0 then
            last_waypoint_index = 1
            pathfinder.set_last_waypoint_index(1)
            last_goal = goal
            -- waypoints = sort_positions(waypoints)
        end
    end

    last_update_time = current_time
    
end)

local last_movement_time = 0
local last_movement_time_pf_lb = 0
local last_lilith_interact_time = 0

local pathfinding_state = {
    open_list = {},
    closed_list = {},
    iterations = 0,
    max_iterations = 1000000,
    path_complete = true,
    current_path = {}
}

local function distance(pos1, pos2)
    return math.sqrt((pos1:x() - pos2:x())^2 + (pos1:y() - pos2:y())^2 + (pos1:z() - pos2:z())^2)
end

local function get_neighbors(pos)
    local neighbors = {}
    local directions = {
        vec3:new(1.0, 0, 0), vec3:new(-1.0, 0, 0),
        vec3:new(0, 1.0, 0), vec3:new(0, -1.0, 0),
        vec3:new(0, 0, 1.0), vec3:new(0, 0, -1.0)
    }

    -- utility.set_height_of_valid_position()
    for _, dir in ipairs(directions) do
        table.insert(neighbors, vec3:new(pos:x() + dir:x(), pos:y() + dir:y(), pos:z() + dir:z()))
    end
    return neighbors
end

local function is_in_list(list, pos)
    for _, node in ipairs(list) do
        if node.pos:x() == pos:x() and node.pos:y() == pos:y() and node.pos:z() == pos:z() then
            return true
        end
    end
    return false
end

local function get_node_from_list(list, pos)
    for _, node in ipairs(list) do
        if node.pos:x() == pos:x() and node.pos:y() == pos:y() and node.pos:z() == pos:z() then
            return node
        end
    end
    return nil
end

local function continue_pathfinding(goal_position, max_distance)
    local start_time = os.clock()
    local time_limit = 0.06 -- 0.2 ms per frame

    while os.clock() - start_time < time_limit and not pathfinding_state.path_complete do
        if #pathfinding_state.open_list == 0 or pathfinding_state.iterations >= pathfinding_state.max_iterations then
            pathfinding_state.path_complete = true
            break
        end

        -- perform a single iteration of pathfinding
        -- ensure this part is optimized as discussed

        if #pathfinding_state.open_list == 0 or pathfinding_state.iterations >= pathfinding_state.max_iterations then
            pathfinding_state.path_complete = true
            break
        end

        pathfinding_state.iterations = pathfinding_state.iterations + 1
        table.sort(pathfinding_state.open_list, function(a, b) return (a.g + a.h) < (b.g + b.h) end)
        local current = table.remove(pathfinding_state.open_list, 1)
        table.insert(pathfinding_state.closed_list, current)

        if distance(current.pos, goal_position) < 1 or #pathfinding_state.current_path >= max_distance then
            while current.parent do
                table.insert(pathfinding_state.current_path, 1, current.pos)
                current = current.parent
            end

            local start_time_ = pathfinding_state.start_time
            local end_time =  os.clock()
            local work_time = end_time - start_time_
            console.print("path solved, time: " .. work_time)
            pathfinding_state.path_complete = true
            break
        end

        local neighbors = get_neighbors(current.pos)
        for _, neighbor in ipairs(neighbors) do
            local neighbor_adjusted = utility.set_height_of_valid_position(neighbor)
            if not is_in_list(pathfinding_state.closed_list, neighbor) and utility.is_point_walkeable_heavy(neighbor_adjusted) then
                local g = current.g + distance(current.pos, neighbor)
                local h = distance(neighbor, goal_position)
                local neighbor_node = {pos = neighbor, g = g, h = h, parent = current}

                if not is_in_list(pathfinding_state.open_list, neighbor) then
                    table.insert(pathfinding_state.open_list, neighbor_node)
                else
                    local existing = get_node_from_list(pathfinding_state.open_list, neighbor)
                    if existing and g < existing.g then
                        existing.g = g
                        existing.parent = current
                    end
                end
            end
        end
    end
end

local function find_walkable_point(center_point)
    local directions = {
        vec3:new(1, 0, 0), vec3:new(0, 1, 0),  -- East, North
        vec3:new(-1, 0, 0), vec3:new(0, -1, 0),  -- West, South
        vec3:new(1, 1, 0), vec3:new(-1, 1, 0),  -- Northeast, Northwest
        vec3:new(1, -1, 0), vec3:new(-1, -1, 0)  -- Southeast, Southwest
    }

    local radii = {0.5, 1.0, 1.5, 2.0, 2.5, 3.0}

    -- First check the original point
    local a = utility.set_height_of_valid_position(center_point)
    if utility.is_point_walkeable_heavy(a) then
        return a
    end

    -- Check in expanding circles around the point
    for _, radius in ipairs(radii) do
        for _, direction in ipairs(directions) do
            local test_point = vec3:new(
                center_point:x() + direction:x() * radius,
                center_point:y() + direction:y() * radius,
                center_point:z()
            )

            local x = utility.set_height_of_valid_position(test_point)
            if utility.is_point_walkeable_heavy(x) then
                return x
            end
        end
    end

    -- No walkable point found within the maximum range
    return nil
end

local max_distance = 50
local start_pos = nil
local goal_position = nil

local function initiate_pathfinding(player_pos, ob_pos, max_distance)
    local walkeable_goal = find_walkable_point(ob_pos)
    local goal_point = ob_pos
    if walkeable_goal then
        goal_point = walkeable_goal
    end

    goal_position = goal_point
    pathfinding_state.open_list = {{pos = player_pos, g = 0, h = distance(player_pos, goal_point)}}
    pathfinding_state.closed_list = {}
    pathfinding_state.iterations = 0
    pathfinding_state.path_complete = false
    pathfinding_state.current_path = {}
    pathfinding_state.start_time = os.clock()
    console.print("initiate_pathfinding " .. os.clock())
end

local debug_enabled = false
local function debug_performance(start_time, label)
    if not debug_enabled then
        return
    end
    local elapsed = os.clock() - start_time
    console.print(label .. " took: " .. elapsed .. " ms")
end

-- local last_cache_update = 0.0
on_render(function()
    local current_time = os.clock()

    -- current_time - last_cache_update >= update_interval and not 
    if not pathfinding_state.path_complete then
        local start_time = os.clock()
        continue_pathfinding(goal_position, max_distance)
        debug_performance(start_time, "Pathfinding Iteration")
        -- last_cache_update = current_time
    end

    for i, pos in ipairs(pathfinding_state.current_path) do
        graphics.circle_3d(pos, 0.3, color_gold(255), 2.0)
    end

    if goal_position then
        graphics.circle_3d(goal_position, 0.3, color_red(255), 2.0)
    end
  
end)

-- Initial variables
local last_position = nil
local last_time_checked = 0
local is_stuck = false
local last_bruteforce_stuck_time = 0.0
local last_obj_vec3 = nil
local last_lilith_id = 0

on_render(function()
    if not menu_elements.enable_plugin:get() or menu_elements.toggle_plugin:get_state() <= 0 then
        return  -- Abort if the plugin is disabled or the toggle keybind is not active
    end

    local current_time = os.time()
    local local_player = get_local_player()
    if not local_player then return end  -- Ensure the local player is available

    if not last_obj_vec3 then
        return
    end

    local current_position = local_player:get_position()
    if not last_position or current_time - last_time_checked > 4.0 then
        -- Initialize last position and time if not set
        last_position = current_position
        last_time_checked = current_time
        return
    end

    -- Calculate the distance moved
    local distance_moved = current_position:dist_to(last_position)

    if distance_moved > 5.0 then
        -- Player has moved more than 2 units, reset the timer and position
        last_position = current_position
        last_time_checked = current_time
        is_stuck = false
    elseif current_time - last_time_checked >= 10 then
        -- Check if 10 seconds have passed and the player hasn't moved more than 2 units
        is_stuck = true
    end

    -- Optionally print or handle the is_stuck status
    if is_stuck then
        -- console.print("Player is stuck.")

        -- backup system
        local obj_id = 2
        local current_time = get_time_since_inject()
        if current_time - last_bruteforce_stuck_time > 20 and obj_id ~= last_lilith_id and last_obj_vec3 then
            local start_bck = find_walkable_point(current_position)
            start_pos = current_position
            if start_bck then
                start_pos = start_bck
            end
            goal_position = last_obj_vec3
            max_distance = 50

            -- utility.set_height_of_valid_position()
            initiate_pathfinding(start_pos, goal_position, max_distance)
            goal_position = goal_position
            console.print("start bruteforce stuck - WAIT PATIENT")
            last_lilith_id = obj_id
            last_waypoint_index_stuck = 0
        end

       
        local stuck_wp = get_next_waypoint_stuck(current_position, pathfinding_state.current_path, 0.35)
        if stuck_wp then
            if current_time - last_movement_time >= 0.20 then

                console.print("pf backup  STUCK 333")
                pathfinder.force_move_raw(stuck_wp)
                last_movement_time = current_time
            end
    
            graphics.circle_3d(stuck_wp, 0.2, color_red(255), 2)

        end
    else
        if last_lilith_id == 2 then
            last_lilith_id = 0
        end
       
        -- console.print("Player is not stuck.")
    end
end)


on_render(function ()

    local local_player = get_local_player()
    if not local_player then
        return
    end

    
    -- waypoints = sort_positions(waypoints)
    pathfinder.sort_waypoints(waypoints, get_player_position())
    for i, waypoint in ipairs(waypoints) do
        -- waypoint = utility.set_height_of_valid_position(waypoint) -- c++ sort waypoints already do it
        graphics.circle_3d(waypoint, 0.2, color_white(255), 2)
        -- graphics.text_3d(tostring(i), waypoint, 35, color_white(255))
    end


    if not menu_elements.enable_plugin:get() or menu_elements.toggle_plugin:get_state() <= 0 then
        return  -- Abort if the plugin is disabled or the toggle keybind is not active
    end

    if not goal or not waypoints or #waypoints < 1 then
        return
    end

    if is_stuck then
        return
    end

    local player_position = get_player_position()

    local current_time = get_time_since_inject()
    local _waypoint = get_next_waypoint(player_position, waypoints, 5.50)

    local end_point = waypoints[#waypoints]
    local dist_sqr_ = player_position:squared_dist_to(end_point)

    local found_lilit = false
    local actors = actors_manager.get_all_actors()
    for _, actor in ipairs(actors) do
        if actor then
            
            local position = actor:get_position()
            local dist_sqrt_a = position:squared_dist_to(goal.position)
            if dist_sqrt_a <= 5.0 * 5.0 then
                if actor:get_skin_name():match("Lilith") then
                    found_lilit = true
                    break
    
                end
            end
        end
    end

    if _waypoint and last_waypoint_index < #waypoints and dist_sqr_ > (5.5 * 5.5) and not found_lilit then
        if current_time - last_movement_time >= 0.66 then
            console.print("force_move_raw -> " .. last_waypoint_index)
            -- pathfinder.force_move_raw(_waypoint)
            last_obj_vec3 = waypoints[last_waypoint_index +1]
            pathfinder.force_move_raw(_waypoint)
            -- pathfinder.move_to_cpathfinder_custom_a2(_waypoint, 1.5, 150)
            last_movement_time = current_time
            last_movement_time_pf_lb = current_time
        end

        graphics.circle_3d(_waypoint, 0.2, color_red(255), 2)
    else

        if current_time - last_lilith_interact_time >= 1 then
            
            -- Check for lilith
            

            table.sort(actors, function(a, b)
                return a:get_position():squared_dist_to_ignore_z(player_position) <
                b:get_position():squared_dist_to_ignore_z(player_position)
            end);

            for _, actor in ipairs(actors) do
                if actor then
                    if actor:get_skin_name():match("Lilith") then
                        found_lilit = true
                        local obj_id = actor:get_id()
                        local actor_position = actor:get_position()

                        if obj_id ~= last_lilith_id then
                            local start_bck = find_walkable_point(player_position)
                            start_pos = player_position
                            if start_bck then
                                start_pos = start_bck
                            end
                            goal_position = actor_position
                            max_distance = 50

                            -- utility.set_height_of_valid_position()
                            initiate_pathfinding(start_pos, goal_position, max_distance)
                            goal_position = goal_position
                            console.print("start bruteforce to lilith - WAIT PATIENT")
                            last_lilith_id = obj_id
                            last_waypoint_index_lilith = 0
                        end
                  
                        local dist = actor_position:dist_to_ignore_z(player_position)
                        if dist > 5.0 then
                            
                            if not pathfinding_state.path_complete then
                                -- local point = find_walkable_point(goal.position)
                                -- if point then
                                --     console.print("pf 111")
                                --     pathfinder.move_to_cpathfinder(point, true)
                                --     last_lilith_interact_time = current_time
                                -- else
                                --     console.print("pf 2222")
                                --     pathfinder.move_to_cpathfinder(actor_position, true)
                                --     last_lilith_interact_time = current_time
                                -- end
                            else
                               
                                local collect_wp = get_next_waypoint_lilith(player_position, pathfinding_state.current_path, 0.35)
                                if collect_wp then
                                    if current_time - last_movement_time >= 1.0 and current_time - last_movement_time_pf_lb > 4.0 then

                                        console.print("pf 333")
                                        -- last_obj_vec3 = collect_wp
                                        pathfinder.force_move_raw(collect_wp)
                                        -- pathfinder.move_to_cpathfinder(collect_wp)
                                        -- pathfinder.move_to_cpathfinder_custom_a2(collect_wp, 0.55, 150)
                                        last_movement_time = current_time
                                    end
                            
                                    graphics.circle_3d(collect_wp, 0.2, color_red(255), 2)
                                else
                                    -- -- ik, repeated code idc now
                                    -- local point = find_walkable_point(goal.position)
                                    -- if point then
                                    --     console.print("pf 444")
                                    --     pathfinder.move_to_cpathfinder(point, true)
                                    --     last_lilith_interact_time = current_time
                                    -- else
                                    --     console.print("pf 555")
                                    --     pathfinder.move_to_cpathfinder(actor_position, true)
                                    --     last_lilith_interact_time = current_time
                                    -- end

                                end
                            end
                            
                            -- console.print("Moving to lilith 111")
                            graphics.text_3d("Lilith Altar (Un-Explored)", actor_position, 20.0, color_white(255))
                            graphics.circle_3d(actor:get_position(), 0.2, color_orange(255), 2)
                        else

                            if current_time - last_movement_time >= 0.15 then

                                last_movement_time = current_time
                                console.print("collecting lilith 222")
                                loot_manager.interact_with_object(actor)
                                graphics.circle_3d(actor:get_position(), 0.2, color_green(255), 2)

                                if dist < 3.0 or not actor:is_interactable() then
                                    graphics.text_3d("Lilith Altar (Explored)", actor_position, 20.0, color_green(255))
                                    --draw will only appear on frame idc for now
                                    goal.interacted = true
                                end

                            end
                        end

                        break
                    end
                end
            end

            if not found_lilit then
                -- backup system

                -- local obj_id = 11
                -- if obj_id ~= last_lilith_id then
                --     local start_bck = find_walkable_point(player_position)
                --         start_pos = player_position
                --         if start_bck then
                --             start_pos = start_bck
                --         end
                --     goal_position = goal.position
                --     max_distance = 50

                --     -- utility.set_height_of_valid_position()
                --     initiate_pathfinding(start_pos, goal_position, max_distance)
                --     goal_position = goal_position
                --     console.print("start bruteforce - WAIT PATIENT")
                --     last_lilith_id = obj_id
                -- end

                -- local collect_wp = get_next_waypoint_2(player_position, pathfinding_state.current_path, 0.35)
                -- if collect_wp then
                --     if current_time - last_movement_time >= 0.66 then

                --         console.print("pf backup 333")
                --         pathfinder.force_move_raw(collect_wp)
                --         last_movement_time = current_time
                --     end
            
                --     graphics.circle_3d(collect_wp, 0.2, color_red(255), 2)

                -- end

                -- console.print("AAAAA")
                -- pathfinder.force_move_raw(stuck_wp)
                pathfinder.move_to_cpathfinder_custom_a1(goal.position, 1.80, 0.70, 100)
                -- graphics.circle_3d(collect_wp, 0.2, color_red(255), 2)
                
            end
        end
        
    end
end)
